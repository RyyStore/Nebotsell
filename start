#!/bin/bash

# Colors
green="\e[38;5;82m"
red="\e[38;5;196m"
neutral="\e[0m"
orange="\e[38;5;130m"
blue="\e[38;5;39m"
yellow="\e[38;5;226m"
purple="\e[38;5;141m"
bold_white="\e[1;37m"
reset="\e[0m"

print_rainbow() {
    local text="$1"
    echo -e "${blue}${text}${reset}"
}

cek_status() {
    status=$(systemctl is-active --quiet $1 && echo "aktif" || echo "nonaktif")
    if [ "$status" = "aktif" ]; then
        echo -e "${green}GOOD${neutral}"
    else
        echo -e "${red}BAD${neutral}"
    fi
}

setup_bot() {
    echo -e "${yellow}Mempersiapkan sistem dan dependensi...${neutral}"
    
    # Update dan Install Redis Server (Wajib untuk modul Bull/Queue)
    apt-get update -y
    apt-get install redis-server bc curl git -y
    systemctl enable redis-server
    systemctl start redis-server

    # Setup Node.js v22
    NODE_VERSION=$(node -v 2>/dev/null | grep -oP '(?<=v)\d+' || echo "0")
    if [ "$NODE_VERSION" -lt 22 ]; then
        echo -e "${yellow}Installing Node.js v22...${neutral}"
        curl -fsSL https://deb.nodesource.com/setup_22.x | sudo -E bash -
        apt-get install -y nodejs
        npm install -g npm@latest
    fi

    # Clone Repository jika belum ada
    if [ ! -d /root/Nebotsell ]; then
        git clone https://github.com/RyyStore/Nebotsell /root/Nebotsell
    fi

    # Instalasi Semua Modul Node.js (Termasuk qrcode, bull, async-mutex, dll)
    echo -e "${yellow}Menginstal modul Node.js (qrcode, bull, dll)...${neutral}"
    cd /root/Nebotsell
    npm install sqlite3 express crypto telegraf axios dotenv moment bcrypt cors \
        express-session session-file-store exceljs qrcode async-mutex bull
    
    chmod +x /root/Nebotsell/*
}

server_app() {
    clear
    print_rainbow "─────────────────────────────────────────"
    echo -e "     .:::.   RYYSTORE BOT AUTO INSTALL   .:::.   "
    print_rainbow "─────────────────────────────────────────"

    # --- Input User ---
    read -p "Masukkan token bot: " token
    while [ -z "$token" ]; do read -p "Token tidak boleh kosong: " token; done

    read -p "Masukkan admin ID: " adminid
    while [ -z "$adminid" ]; do read -p "Admin ID tidak boleh kosong: " adminid; done

    read -p "Masukkan nama store: " namastore
    while [ -z "$namastore" ]; do read -p "Nama store tidak boleh kosong: " namastore; done

    # --- Data Default Terintegrasi (Otomatis) ---
    orkut_merchant_id="OK2285905"
    orkut_username="rkptr"
    orkut_token="2285905:dSCEsiN7vxrnZLVqk6P08FIUbopQhKfa"
    qris_statis_string="00020101021126670016COM.NOBUBANK.WWW01189360050300000879140214550177920473550303UMI51440014ID.CO.QRIS.WWW0215ID20253782970190303UMI5204541153033605802ID5918RYYSTORE OK22859056009SURAKARTA61055712462070703A016304774D"
    ft_hash="d7c3e75912254b4891fb9abb196cacd5"
    ft_merchant="M40615AED"

    # --- Create .vars.json ---
    echo -e "${yellow}Menyimpan konfigurasi .vars.json...${neutral}"
    cat > /root/Nebotsell/.vars.json <<EOF
{
  "BOT_TOKEN": "$token",
  "USER_ID": "$adminid",
  "NAMA_STORE": "$namastore",
  "PORT": "50123",
  "ORKUT_MERCHANT_ID": "$orkut_merchant_id",
  "ORKUT_USERNAME": "$orkut_username",
  "ORKUT_TOKEN": "$orkut_token",
  "QRIS_STATIS_STRING": "$qris_statis_string",
  "OKE_API_BASE": "$orkut_merchant_id",
  "FT_HASH": "$ft_hash",
  "FT_MERCHANT_CODE": "$ft_merchant"
}
EOF

    # --- Systemd Setup ---
    cat > /etc/systemd/system/sellvpn.service <<EOF
[Unit]
Description=NebotSell Telegram Bot Service
After=network.target redis-server.service

[Service]
ExecStart=/usr/bin/node /root/Nebotsell/app.js
Restart=always
User=root
Environment=NODE_ENV=production
WorkingDirectory=/root/Nebotsell

[Install]
WantedBy=multi-user.target
EOF

    # --- Auto Backup DB Script ---
    echo '#!/bin/bash' > /usr/bin/server_sellvpn
    echo "curl -s -F chat_id=\"$adminid\" -F document=@\"/root/Nebotsell/sellvpn.db\" \"https://api.telegram.org/bot$token/sendDocument\" >/dev/null 2>&1" >> /usr/bin/server_sellvpn
    chmod +x /usr/bin/server_sellvpn

    # Cron Job Backup setiap 6 jam
    echo "0 */6 * * * root /usr/bin/server_sellvpn" > /etc/cron.d/server_sellvpn

    # Restart Services
    systemctl daemon-reload
    systemctl enable sellvpn.service
    systemctl restart redis-server
    systemctl restart sellvpn.service
    
    clear
    print_rainbow "─────────────────────────────────────────"
    echo -e "       Redis Status  : $(cek_status redis-server)"
    echo -e "       Bot Status    : $(cek_status sellvpn.service)"
    print_rainbow "─────────────────────────────────────────"
    echo -e "${green}Instalasi Selesai!${neutral}"
    echo -e "Silakan buka Telegram dan ketik ${bold_white}/start${neutral}"
}

# Execution
if [[ ${1} == "nebotsell" ]]; then
    setup_bot
    server_app
else
    echo -e "${red}Format salah! Gunakan command: ${yellow}bash namafile.sh nebotsell${neutral}"
    exit 1
fi